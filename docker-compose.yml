version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: instagram_ai_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: instagram_ai
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ${DB_PASSWORD:-password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d instagram_ai"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - instagram_ai_network

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: instagram_ai_redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-password} --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-password}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - instagram_ai_network

  # Backend API (Node.js/Express)
  backend-api:
    build:
      context: ./backend-api
      dockerfile: Dockerfile
    container_name: instagram_ai_backend
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgresql://admin:${DB_PASSWORD:-password}@postgres:5432/instagram_ai
      REDIS_URL: redis://:${REDIS_PASSWORD:-password}@redis:6379
      JWT_SECRET: ${JWT_SECRET}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      STRIPE_PRICE_STARTER: ${STRIPE_PRICE_STARTER}
      STRIPE_PRICE_PROFESSIONAL: ${STRIPE_PRICE_PROFESSIONAL}
      STRIPE_PRICE_PREMIUM: ${STRIPE_PRICE_PREMIUM}
      STRIPE_PRICE_ENTERPRISE: ${STRIPE_PRICE_ENTERPRISE}
      # Apify - Multiple Actors
      APIFY_API_TOKEN: ${APIFY_API_TOKEN}
      APIFY_ACTOR_ID: ${APIFY_ACTOR_ID:-curious_coder/instagram-scraper}
      APIFY_ACTOR_PROFILE_1: ${APIFY_ACTOR_PROFILE_1:-curious_coder/instagram-scraper}
      APIFY_ACTOR_PROFILE_2: ${APIFY_ACTOR_PROFILE_2:-coderx/instagram-profile-scraper-bio-posts}
      APIFY_ACTOR_PROFILE_3: ${APIFY_ACTOR_PROFILE_3:-apify/instagram-profile-scraper}
      APIFY_ACTOR_HASHTAG: ${APIFY_ACTOR_HASHTAG:-apify/instagram-hashtag-scraper}
      APIFY_ACTOR_FOLLOWERS: ${APIFY_ACTOR_FOLLOWERS:-apify/instagram-followers-count-scraper}
      APIFY_ACTOR_FOLLOWING: ${APIFY_ACTOR_FOLLOWING:-louisdeconinck/instagram-following-scraper}
      APIFY_ACTOR_COMMENTS: ${APIFY_ACTOR_COMMENTS:-louisdeconinck/instagram-comments-scraper}
      APIFY_ACTOR_STORIES: ${APIFY_ACTOR_STORIES:-datavoyantlab/advanced-instagram-stories-scraper}
      APIFY_ACTOR_TRANSCRIPT: ${APIFY_ACTOR_TRANSCRIPT:-sian.agency/instagram-ai-transcript-extractor}
      AGENT_ORCHESTRATOR_URL: http://agent-orchestrator:8000
      PDF_GENERATOR_URL: http://pdf-generator:3002
      PDF_GENERATOR_V2_URL: http://pdf-generator-v2:3006
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "3001:3001"
    networks:
      - instagram_ai_network
    restart: unless-stopped

  # Agent Orchestrator (Python/FastAPI)
  agent-orchestrator:
    build:
      context: ./agent-orchestrator
      dockerfile: Dockerfile
    container_name: instagram_ai_agents
    environment:
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      DEEPSEEK_BASE_URL: ${DEEPSEEK_BASE_URL:-https://api.deepseek.com}
      DEEPSEEK_MODEL: ${DEEPSEEK_MODEL:-deepseek-chat}
      APIFY_API_TOKEN: ${APIFY_API_TOKEN}
      REDIS_URL: redis://:${REDIS_PASSWORD:-password}@redis:6379
      DATABASE_URL: postgresql://admin:${DB_PASSWORD:-password}@postgres:5432/instagram_ai
      BACKEND_WEBHOOK_URL: http://backend-api:3001/api/webhooks/analysis-update
    depends_on:
      - redis
      - postgres
    ports:
      - "8000:8000"
    networks:
      - instagram_ai_network
    restart: unless-stopped

  # PDF Generator V1 (Node.js/Puppeteer) - Legacy
  pdf-generator:
    build:
      context: ./pdf-generator
      dockerfile: Dockerfile
    container_name: instagram_ai_pdf
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      S3_BUCKET: ${S3_BUCKET}
      REDIS_URL: redis://:${REDIS_PASSWORD:-password}@redis:6379
      PUBLIC_URL: http://localhost:3002
      FRONTEND_URL: http://frontend:3000
    depends_on:
      - redis
      - frontend
    ports:
      - "3002:3002"
    volumes:
      - pdf_storage:/app/storage
    networks:
      - instagram_ai_network
    restart: unless-stopped

  # PDF Generator V2 (Python/WeasyPrint) - Optimal Performance
  pdf-generator-v2:
    build:
      context: ./pdf-generator-v2
      dockerfile: Dockerfile
    container_name: instagram_ai_pdf_v2
    environment:
      PORT: 3006
      HOST: 0.0.0.0
      DEBUG: "false"
      STORAGE_PATH: /app/storage/reports
      DATABASE_URL: postgresql://admin:${DB_PASSWORD:-password}@postgres:5432/instagram_ai
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      S3_BUCKET: ${S3_BUCKET}
      REDIS_URL: redis://:${REDIS_PASSWORD:-password}@redis:6379
      PUBLIC_URL: http://localhost:3006
    depends_on:
      - redis
      - postgres
    ports:
      - "3006:3006"
    volumes:
      - pdf_storage_v2:/app/storage
    networks:
      - instagram_ai_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Payment Service (Stripe webhooks)
  payment-service:
    build:
      context: ./payment-service
      dockerfile: Dockerfile
    container_name: instagram_ai_payments
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgresql://admin:${DB_PASSWORD:-password}@postgres:5432/instagram_ai
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "4002:4002"
    networks:
      - instagram_ai_network
    restart: unless-stopped

  # Frontend (Next.js)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: instagram_ai_frontend
    environment:
      NEXT_PUBLIC_API_URL: https://www.coriumai-local.com/api
      NEXT_PUBLIC_WS_URL: wss://www.coriumai-local.com
      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY}
    depends_on:
      - backend-api
    ports:
      - "3000:3000"
    networks:
      - instagram_ai_network
    restart: unless-stopped

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: instagram_ai_nginx
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - backend-api
      - frontend
      - agent-orchestrator
    networks:
      - instagram_ai_network
    restart: unless-stopped

  # Cloudflare Tunnel â€” exposes backend-api to Vercel/public internet
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: instagram_ai_tunnel
    restart: unless-stopped
    command: tunnel --no-autoupdate --config /etc/cloudflared/config.yml run --token ${TUNNEL_TOKEN}
    environment:
      TUNNEL_TOKEN: ${TUNNEL_TOKEN}
    volumes:
      - ./docker/cloudflared/config.yml:/etc/cloudflared/config.yml:ro
    depends_on:
      - backend-api
    networks:
      - instagram_ai_network

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  pdf_storage:
    driver: local
  pdf_storage_v2:
    driver: local

networks:
  instagram_ai_network:
    driver: bridge
